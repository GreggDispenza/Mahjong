<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Mahjong Online</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#1a1a2e;color:#fff;min-height:100vh}
    .screen{display:none;min-height:100vh}
    .screen.active{display:flex;flex-direction:column}
    
    /* Loading */
    #loading{justify-content:center;align-items:center;background:#1a1a2e}
    .loader{text-align:center}
    .loader-tile{font-size:80px;animation:bounce 1s infinite}
    @keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-20px)}}
    .loader p{margin-top:20px;color:#888}
    
    /* Auth */
    #auth{justify-content:center;align-items:center;padding:20px;background:linear-gradient(135deg,#1a1a2e 0%,#16213e 100%)}
    .auth-box{background:#16213e;border-radius:20px;padding:30px;width:100%;max-width:380px;box-shadow:0 10px 40px rgba(0,0,0,0.3)}
    .auth-box h1{text-align:center;font-size:28px;margin-bottom:25px}
    .auth-box h1 span{font-size:40px;display:block;margin-bottom:10px}
    .tabs{display:flex;margin-bottom:20px;background:#1a1a2e;border-radius:10px;padding:4px}
    .tabs button{flex:1;padding:12px;border:none;background:none;color:#888;font-size:15px;cursor:pointer;border-radius:8px;transition:all 0.3s}
    .tabs button.active{background:#e94560;color:#fff}
    .form{display:none;flex-direction:column;gap:15px}
    .form.active{display:flex}
    .form input{padding:15px;border:2px solid #2a2a4a;border-radius:10px;background:#1a1a2e;color:#fff;font-size:16px}
    .form input:focus{outline:none;border-color:#e94560}
    .form input::placeholder{color:#666}
    .btn{padding:15px 25px;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;transition:all 0.3s}
    .btn-primary{background:linear-gradient(135deg,#e94560,#c73e54);color:#fff}
    .btn-primary:hover{transform:translateY(-2px);box-shadow:0 5px 20px rgba(233,69,96,0.4)}
    .error-msg{color:#e94560;font-size:14px;text-align:center;min-height:20px}
    
    /* Lobby */
    #lobby{background:#1a1a2e}
    .header{display:flex;justify-content:space-between;align-items:center;padding:15px 20px;background:#16213e;border-bottom:1px solid #2a2a4a}
    .header .user{font-weight:600}
    .header .user span{margin-right:8px}
    .btn-small{padding:8px 15px;font-size:14px;background:#2a2a4a;color:#fff;border:none;border-radius:8px;cursor:pointer}
    .lobby-body{padding:20px;max-width:500px;margin:0 auto;width:100%}
    .create-join{display:flex;flex-direction:column;gap:12px;margin-bottom:30px}
    .btn-large{padding:18px;font-size:18px;width:100%}
    .join-row{display:flex;gap:10px}
    .join-row input{flex:1;padding:15px;font-size:20px;text-align:center;letter-spacing:8px;text-transform:uppercase;background:#16213e;border:2px solid #2a2a4a;border-radius:10px;color:#fff}
    .join-row input:focus{outline:none;border-color:#f4d03f}
    .join-row .btn{padding:15px 25px}
    .section{margin-bottom:25px}
    .section h2{font-size:14px;color:#888;text-transform:uppercase;letter-spacing:1px;margin-bottom:12px}
    .room-list{display:flex;flex-direction:column;gap:10px}
    .room-card{display:flex;justify-content:space-between;align-items:center;padding:18px;background:#16213e;border-radius:12px;cursor:pointer;transition:all 0.3s;border:2px solid transparent}
    .room-card:hover{border-color:#f4d03f;transform:translateX(5px)}
    .room-card .code{font-size:22px;font-weight:700;color:#f4d03f;letter-spacing:3px}
    .room-card .count{color:#888}
    .empty{color:#666;text-align:center;padding:30px}
    .lb-list{background:#16213e;border-radius:12px;overflow:hidden}
    .lb-row{display:grid;grid-template-columns:40px 1fr 80px;padding:14px 18px;border-bottom:1px solid #2a2a4a}
    .lb-row:last-child{border:none}
    .lb-row .rank{color:#f4d03f;font-weight:700}
    .lb-row .score{text-align:right;color:#888}
    
    /* Waiting */
    #waiting{justify-content:center;align-items:center;padding:20px;background:#1a1a2e}
    .wait-box{background:#16213e;border-radius:20px;padding:30px;width:100%;max-width:420px;text-align:center}
    .wait-box h2{font-size:24px;margin-bottom:25px}
    .wait-box h2 span{color:#f4d03f;letter-spacing:4px}
    .seats{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:25px}
    .seat{padding:20px;background:#1a1a2e;border-radius:12px;border:2px solid #2a2a4a}
    .seat.filled{border-color:#4ecca3}
    .seat.me{border-color:#f4d03f}
    .seat .wind{font-size:13px;color:#888;margin-bottom:5px}
    .seat .name{font-size:16px;font-weight:500}
    .seat .name.empty{color:#444}
    .wait-box .btn{margin-top:10px;width:100%}
    
    /* Game */
    #game{background:#0d1117;position:relative}
    .game-container{flex:1;position:relative;max-width:100%;overflow:hidden}
    .opp{position:absolute;display:flex;flex-direction:column;align-items:center}
    .opp.top{top:10px;left:50%;transform:translateX(-50%)}
    .opp.left{left:10px;top:50%;transform:translateY(-50%)}
    .opp.right{right:10px;top:50%;transform:translateY(-50%)}
    .opp-name{font-size:12px;color:#888;margin-bottom:5px;background:#1a1a2e;padding:4px 10px;border-radius:10px}
    .opp-tiles{display:flex;gap:2px}
    .opp.left .opp-tiles,.opp.right .opp-tiles{flex-direction:column}
    .back-tile{width:24px;height:34px;background:linear-gradient(135deg,#2d5a45,#1e3d2f);border-radius:4px;border:1px solid #3d7a5a}
    .opp.left .back-tile,.opp.right .back-tile{width:34px;height:24px}
    .opp-melds{display:flex;gap:6px;margin-top:6px}
    .center-area{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center}
    .game-info{display:flex;gap:20px;justify-content:center;align-items:center;margin-bottom:15px}
    .game-info .wind{font-size:32px;color:#f4d03f}
    .game-info .wall{color:#888;font-size:14px}
    .discard-pile{display:flex;flex-wrap:wrap;gap:3px;justify-content:center;max-width:220px;padding:15px;background:rgba(0,0,0,0.4);border-radius:12px;min-height:80px}
    .discard-pile .tile{width:26px;height:36px;font-size:18px;cursor:default}
    .discard-pile .tile:hover{transform:none}
    .last-discard{margin-top:15px}
    .last-discard .tile{width:44px;height:58px;font-size:32px;border:2px solid #e94560;box-shadow:0 0 20px rgba(233,69,96,0.5);animation:pulse 1s infinite;cursor:default}
    .last-discard .tile:hover{transform:none}
    @keyframes pulse{0%,100%{box-shadow:0 0 20px rgba(233,69,96,0.5)}50%{box-shadow:0 0 30px rgba(233,69,96,0.8)}}
    .my-section{position:absolute;bottom:70px;left:50%;transform:translateX(-50%);display:flex;flex-direction:column;align-items:center;width:95%;max-width:550px}
    .my-melds{display:flex;gap:10px;margin-bottom:10px}
    .meld{display:flex;gap:2px;background:rgba(0,0,0,0.3);padding:5px;border-radius:8px}
    .meld .tile{width:30px;height:42px;font-size:22px;cursor:default}
    .meld .tile:hover{transform:none}
    .my-hand{display:flex;flex-wrap:wrap;gap:5px;justify-content:center;padding:15px;background:rgba(0,0,0,0.4);border-radius:15px}
    .my-info{margin-top:10px;font-size:14px;color:#888}
    .tile{width:40px;height:54px;background:linear-gradient(145deg,#f5f0e6,#e8e3d5);border:2px solid #c9bda3;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:28px;cursor:pointer;transition:transform 0.15s,box-shadow 0.15s;user-select:none}
    .tile:hover{transform:translateY(-8px)}
    .tile.selected{transform:translateY(-12px);border-color:#f4d03f;box-shadow:0 8px 25px rgba(244,208,63,0.4)}
    .actions{position:fixed;bottom:0;left:0;right:0;display:flex;justify-content:center;gap:8px;padding:12px;background:linear-gradient(to top,#0d1117 0%,transparent 100%)}
    .actions .btn{padding:12px 18px;font-size:14px;background:#1a1a2e;border:1px solid #2a2a4a;color:#fff}
    .actions .btn:disabled{opacity:0.4;cursor:not-allowed}
    .actions .btn-win{background:#e94560;border-color:#e94560}
    .actions .btn-skip{background:transparent;color:#888}
    .turn-indicator{position:fixed;top:60px;left:50%;transform:translateX(-50%);padding:10px 25px;background:#f4d03f;color:#000;font-weight:700;border-radius:25px;opacity:0;transition:opacity 0.3s}
    .turn-indicator.show{opacity:1}
    
    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.85);display:none;justify-content:center;align-items:center;padding:20px;z-index:100}
    .modal.active{display:flex}
    .modal-content{background:#16213e;border-radius:20px;padding:35px;text-align:center;max-width:450px;width:100%}
    .modal-content h2{font-size:26px;margin-bottom:10px}
    .modal-content .score-big{font-size:48px;color:#f4d03f;font-weight:700;margin:15px 0}
    .win-tiles{display:flex;flex-wrap:wrap;gap:5px;justify-content:center;margin:20px 0;padding:15px;background:#1a1a2e;border-radius:12px}
    .win-tiles .tile{width:34px;height:46px;font-size:24px;cursor:default}
    .win-tiles .tile:hover{transform:none}
    
    /* Responsive */
    @media(max-width:480px){
      .tile{width:32px;height:44px;font-size:22px}
      .meld .tile{width:26px;height:36px;font-size:18px}
      .discard-pile .tile{width:22px;height:30px;font-size:14px}
      .back-tile{width:20px;height:28px}
      .opp.left .back-tile,.opp.right .back-tile{width:28px;height:20px}
      .last-discard .tile{width:36px;height:48px;font-size:26px}
      .actions .btn{padding:10px 14px;font-size:12px}
      .win-tiles .tile{width:28px;height:38px;font-size:20px}
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Loading -->
    <div id="loading" class="screen active">
      <div class="loader">
        <div class="loader-tile">üÄÑ</div>
        <p>Loading...</p>
      </div>
    </div>

    <!-- Auth -->
    <div id="auth" class="screen">
      <div class="auth-box">
        <h1><span>üÄÑ</span>Mahjong</h1>
        <div class="tabs">
          <button class="active" onclick="showTab('login')">Login</button>
          <button onclick="showTab('register')">Register</button>
        </div>
        <form id="login-form" class="form active" onsubmit="doLogin(event)">
          <input type="text" id="l-user" placeholder="Username" required>
          <input type="password" id="l-pass" placeholder="Password" required>
          <button type="submit" class="btn btn-primary">Login</button>
          <div class="error-msg" id="l-err"></div>
        </form>
        <form id="register-form" class="form" onsubmit="doRegister(event)">
          <input type="text" id="r-user" placeholder="Username (3+ characters)" required minlength="3">
          <input type="text" id="r-name" placeholder="Display Name" required>
          <input type="password" id="r-pass" placeholder="Password (4+ characters)" required minlength="4">
          <button type="submit" class="btn btn-primary">Create Account</button>
          <div class="error-msg" id="r-err"></div>
        </form>
      </div>
    </div>

    <!-- Lobby -->
    <div id="lobby" class="screen">
      <div class="header">
        <div class="user"><span>üÄÑ</span><span id="my-name">Player</span></div>
        <button class="btn-small" onclick="doLogout()">Logout</button>
      </div>
      <div class="lobby-body">
        <div class="create-join">
          <button class="btn btn-primary btn-large" onclick="createRoom()">Create Room</button>
          <div class="join-row">
            <input type="text" id="join-code" placeholder="CODE" maxlength="4">
            <button class="btn btn-primary" onclick="joinRoom()">Join</button>
          </div>
        </div>
        <div class="section">
          <h2>Open Rooms</h2>
          <div id="rooms" class="room-list"></div>
        </div>
        <div class="section">
          <h2>Leaderboard</h2>
          <div id="lb" class="lb-list"></div>
        </div>
      </div>
    </div>

    <!-- Waiting -->
    <div id="waiting" class="screen">
      <div class="wait-box">
        <h2>Room: <span id="room-code">XXXX</span></h2>
        <div id="seats" class="seats"></div>
        <button id="start-btn" class="btn btn-primary" onclick="startGame()" disabled>Waiting for players...</button>
        <button class="btn btn-small" onclick="leaveRoom()">Leave Room</button>
      </div>
    </div>

    <!-- Game -->
    <div id="game" class="screen">
      <div class="game-container">
        <div class="opp top" id="opp-top">
          <div class="opp-name"></div>
          <div class="opp-tiles"></div>
          <div class="opp-melds"></div>
        </div>
        <div class="opp left" id="opp-left">
          <div class="opp-name"></div>
          <div class="opp-tiles"></div>
          <div class="opp-melds"></div>
        </div>
        <div class="opp right" id="opp-right">
          <div class="opp-name"></div>
          <div class="opp-tiles"></div>
          <div class="opp-melds"></div>
        </div>
        <div class="center-area">
          <div class="game-info">
            <span class="wind" id="round-wind">Êù±</span>
            <span class="wall">Tiles: <span id="wall-count">144</span></span>
          </div>
          <div id="discards" class="discard-pile"></div>
          <div id="last" class="last-discard"></div>
        </div>
        <div class="my-section">
          <div id="my-melds" class="my-melds"></div>
          <div id="my-hand" class="my-hand"></div>
          <div class="my-info" id="my-info"></div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" id="btn-chow" onclick="claimChow()" disabled>Chow</button>
        <button class="btn" id="btn-pung" onclick="claimPung()" disabled>Pung</button>
        <button class="btn" id="btn-kong" onclick="claimKong()" disabled>Kong</button>
        <button class="btn btn-win" id="btn-mj" onclick="claimMahjong()" disabled>Mahjong!</button>
        <button class="btn btn-skip" onclick="skip()">Skip</button>
      </div>
      <div class="turn-indicator" id="turn-ind">Your Turn</div>
    </div>

    <!-- Win Modal -->
    <div id="win-modal" class="modal">
      <div class="modal-content">
        <h2>üéâ <span id="winner-name">Player</span> Wins!</h2>
        <div class="score-big"><span id="win-score">0</span></div>
        <div id="win-hand" class="win-tiles"></div>
        <button class="btn btn-primary" onclick="backToLobby()">Back to Lobby</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    let socket, user, currentRoom, gameState, selectedTiles = [];

    // Helpers
    const $=id=>document.getElementById(id);
    const show=id=>{document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));$(id).classList.add('active')};
    const api=async(url,opts={})=>{const r=await fetch(url,{...opts,headers:{'Content-Type':'application/json'},credentials:'include'});return r.json()};

    // Auth
    function showTab(tab){
      document.querySelectorAll('.tabs button').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('.form').forEach(f=>f.classList.remove('active'));
      event.target.classList.add('active');
      $(tab+'-form').classList.add('active');
    }

    async function doLogin(e){
      e.preventDefault();
      const d=await api('/api/login',{method:'POST',body:JSON.stringify({username:$('l-user').value,password:$('l-pass').value})});
      if(d.success){user=d.user;localStorage.setItem('token',d.token);initSocket();showLobby()}
      else $('l-err').textContent=d.error||'Login failed';
    }

    async function doRegister(e){
      e.preventDefault();
      const d=await api('/api/register',{method:'POST',body:JSON.stringify({username:$('r-user').value,displayName:$('r-name').value,password:$('r-pass').value})});
      if(d.success){user=d.user;localStorage.setItem('token',d.token);initSocket();showLobby()}
      else $('r-err').textContent=d.error||'Registration failed';
    }

    function doLogout(){api('/api/logout',{method:'POST'});localStorage.removeItem('token');user=null;if(socket)socket.disconnect();show('auth')}

    async function checkAuth(){
      try{const d=await api('/api/me');if(d.user){user=d.user;initSocket();showLobby();return true}}catch{}
      show('auth');return false;
    }

    // Socket
    function initSocket(){
      socket=io();
      socket.on('connect',()=>{const t=localStorage.getItem('token');if(t)socket.emit('auth',t,r=>{if(!r.success)doLogout()})});
      socket.on('lobbyCreated',loadRooms);
      socket.on('lobbyUpdated',loadRooms);
      socket.on('lobbyRemoved',loadRooms);
      socket.on('playerJoined',d=>updateSeats(d.players||[]));
      socket.on('playerLeft',d=>updateSeats(d.players||[]));
      socket.on('readyToStart',d=>{updateSeats(d.players);$('start-btn').disabled=false;$('start-btn').textContent='Start Game!'});
      socket.on('gameStarted',d=>{gameState=d;show('game');renderGame()});
      socket.on('stateUpdate',d=>{gameState=d;renderGame()});
      socket.on('gameWon',handleWin);
      socket.on('gameDraw',()=>{alert('Draw!');backToLobby()});
    }

    // Lobby
    function showLobby(){show('lobby');$('my-name').textContent=user.displayName;loadRooms();loadLeaderboard()}

    async function loadRooms(){
      const d=await api('/api/lobbies');
      $('rooms').innerHTML=d.length?d.map(r=>`<div class="room-card" onclick="joinRoomByCode('${r.roomCode}')"><span class="code">${r.roomCode}</span><span class="count">${r.playerCount}/4</span></div>`).join(''):'<div class="empty">No open rooms</div>';
    }

    async function loadLeaderboard(){
      const d=await api('/api/leaderboard');
      $('lb').innerHTML=d.length?d.slice(0,8).map((p,i)=>`<div class="lb-row"><span class="rank">${i+1}</span><span>${p.display_name}</span><span class="score">${p.total_score}</span></div>`).join(''):'<div class="empty">No games yet</div>';
    }

    function createRoom(){socket.emit('createRoom',r=>{if(r.success){currentRoom=r.roomCode;showWaiting(r)}else alert(r.error||'Failed')})}
    function joinRoom(){const c=$('join-code').value.toUpperCase();if(c)joinRoomByCode(c)}
    function joinRoomByCode(code){socket.emit('joinRoom',code,r=>{if(r.success){currentRoom=r.roomCode;showWaiting(r)}else alert(r.error||'Failed')})}

    function showWaiting(r){show('waiting');$('room-code').textContent=r.roomCode;updateSeats(r.players);$('start-btn').disabled=r.players.length<4;$('start-btn').textContent=r.players.length<4?`Waiting... (${r.players.length}/4)`:'Start Game!'}

    function updateSeats(players){
      const w=['east','south','west','north'],l=['Êù± East','Âçó South','Ë•ø West','Âåó North'];
      $('seats').innerHTML=w.map((wind,i)=>{
        const p=players.find(x=>x.seatWind===wind);
        const isMe=p&&p.oderId===user.id;
        return`<div class="seat${p?' filled':''}${isMe?' me':''}"><div class="wind">${l[i]}</div><div class="name${p?'':' empty'}">${p?p.displayName:'Waiting...'}</div></div>`;
      }).join('');
      if(players.length===4){$('start-btn').disabled=false;$('start-btn').textContent='Start Game!'}
    }

    function leaveRoom(){socket.emit('leaveRoom');currentRoom=null;showLobby()}
    function startGame(){socket.emit('startGame',r=>{if(!r.success)alert(r.error||'Failed')})}

    // Game
    function renderGame(){
      if(!gameState)return;
      // Hand
      $('my-hand').innerHTML=(gameState.myHand||[]).map(t=>`<div class="tile${selectedTiles.includes(t.id)?' selected':''}" onclick="clickTile(${t.id})">${t.char}</div>`).join('');
      // Melds
      $('my-melds').innerHTML=(gameState.myExposed||[]).map(m=>`<div class="meld">${m.tiles.map(t=>`<div class="tile">${t.char}</div>`).join('')}</div>`).join('');
      // Info
      $('my-info').textContent=`${user.displayName} - ${(gameState.mySeatWind||'')[0]?.toUpperCase()||''}`;
      // Wall
      $('wall-count').textContent=gameState.wallCount||0;
      // Discards
      $('discards').innerHTML=(gameState.discardPile||[]).map(t=>`<div class="tile">${t.char}</div>`).join('');
      // Last
      $('last').innerHTML=gameState.lastDiscard?`<div class="tile">${gameState.lastDiscard.char}</div>`:'';
      // Opponents
      renderOpponents();
      // Buttons
      $('btn-chow').disabled=!gameState.canChow;
      $('btn-pung').disabled=!gameState.canPung;
      $('btn-kong').disabled=!gameState.canKong;
      $('btn-mj').disabled=!gameState.canMahjong;
      // Turn
      $('turn-ind').classList.toggle('show',gameState.isMyTurn);
    }

    function renderOpponents(){
      if(!gameState.players)return;
      const myIdx=gameState.players.findIndex(p=>p.oderId===user.id);
      const pos=['opp-right','opp-top','opp-left'];
      gameState.players.forEach((p,i)=>{
        if(p.oderId===user.id)return;
        const rel=(i-myIdx+4)%4;
        if(rel<1||rel>3)return;
        const el=$(pos[rel-1]);
        if(!el)return;
        el.querySelector('.opp-name').textContent=p.displayName;
        el.querySelector('.opp-tiles').innerHTML=Array(p.handCount||0).fill('<div class="back-tile"></div>').join('');
        el.querySelector('.opp-melds').innerHTML=(p.exposed||[]).map(m=>`<div class="meld">${m.tiles.map(t=>`<div class="tile" style="width:24px;height:32px;font-size:16px">${t.char}</div>`).join('')}</div>`).join('');
      });
    }

    function clickTile(id){
      if(!gameState.isMyTurn)return;
      if(selectedTiles.includes(id)){
        socket.emit('discard',id,r=>{if(r.success)selectedTiles=[]});
        selectedTiles=[];
      }else{
        selectedTiles=[id];
      }
      renderGame();
    }

    function claimPung(){socket.emit('claimPung',r=>{if(!r.success)alert(r.error||'Cannot')})}
    function claimKong(){socket.emit('claimKong',r=>{if(!r.success)alert(r.error||'Cannot')})}
    function claimChow(){if(selectedTiles.length===2)socket.emit('claimChow',selectedTiles,r=>{if(r.success)selectedTiles=[];else alert(r.error)});else alert('Select 2 tiles')}
    function claimMahjong(){socket.emit('mahjong',!!gameState.lastDiscard,r=>{if(!r.success)alert(r.error||'Not winning')})}
    function skip(){selectedTiles=[];renderGame()}

    function handleWin(d){
      $('winner-name').textContent=d.winnerName;
      $('win-score').textContent=d.score;
      $('win-hand').innerHTML=[...(d.hand||[]),...(d.exposed||[]).flatMap(m=>m.tiles)].map(t=>`<div class="tile">${t.char}</div>`).join('');
      $('win-modal').classList.add('active');
    }

    function backToLobby(){$('win-modal').classList.remove('active');socket.emit('leaveRoom');currentRoom=null;gameState=null;showLobby()}

    // Init
    window.onload=()=>setTimeout(()=>{checkAuth().then(()=>$('loading').classList.remove('active'))},500);
  </script>
</body>
</html>
