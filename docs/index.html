<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HKOS Mahjong - Hong Kong Old Style</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 28px;
            color: #1e3c72;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .compliance-badge {
            background: #22c55e;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .username {
            font-weight: 600;
            color: #1e3c72;
        }

        .btn-logout {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-logout:hover {
            background: #dc2626;
        }

        /* Auth Section */
        #auth-section {
            background: white;
            padding: 40px;
            border-radius: 10px;
            max-width: 400px;
            margin: 100px auto;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        #auth-section h2 {
            margin-bottom: 20px;
            color: #1e3c72;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .btn-primary {
            width: 100%;
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin-top: 10px;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-secondary {
            width: 100%;
            background: #6b7280;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin-top: 10px;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .error-message {
            background: #fee2e2;
            color: #dc2626;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        /* Lobby Section */
        #lobby-section {
            display: none;
        }

        .lobby-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .lobby-panel {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .lobby-panel h2 {
            color: #1e3c72;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .room-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .room-item {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s;
        }

        .room-item:hover {
            border-color: #3b82f6;
            transform: translateX(5px);
        }

        .room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .room-id {
            font-weight: 600;
            color: #1e3c72;
            font-size: 14px;
        }

        .player-count {
            background: #3b82f6;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .room-players {
            font-size: 13px;
            color: #6b7280;
        }

        .player-chip {
            display: inline-block;
            background: #dbeafe;
            color: #1e40af;
            padding: 2px 8px;
            border-radius: 12px;
            margin-right: 5px;
            font-size: 12px;
        }

        .player-chip.ai {
            background: #e5e7eb;
            color: #4b5563;
        }

        .btn-create-room {
            width: 100%;
            background: #22c55e;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin-top: 15px;
        }

        .btn-create-room:hover {
            background: #16a34a;
        }

        /* Game Section */
        #game-section {
            display: none;
        }

        .game-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Game Info Bar */
        .game-info-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #1e3c72;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .game-status {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .status-item {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .status-label {
            font-size: 11px;
            opacity: 0.8;
            text-transform: uppercase;
        }

        .status-value {
            font-size: 16px;
            font-weight: 600;
        }

        .wall-counter {
            display: flex;
            gap: 15px;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 15px;
            border-radius: 6px;
        }

        .wall-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .wall-label {
            font-size: 10px;
            opacity: 0.8;
        }

        .wall-count {
            font-size: 18px;
            font-weight: bold;
        }

        /* Players Grid */
        .players-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .player-box {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            border: 3px solid #e5e7eb;
            position: relative;
        }

        .player-box.active {
            border-color: #22c55e;
            background: #f0fdf4;
        }

        .player-box.you {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .player-name {
            font-weight: 600;
            font-size: 14px;
            color: #1e3c72;
        }

        .player-name.ai {
            color: #6b7280;
        }

        .player-wind {
            background: #1e3c72;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .furiten-badge {
            display: none;
            background: #ef4444;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-top: 5px;
            animation: blink 1.5s infinite;
        }

        .furiten-badge.active {
            display: inline-block;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.4; }
        }

        .player-stats {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 10px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
        }

        /* Tiles Display */
        .tiles-section {
            margin-top: 15px;
        }

        .section-label {
            font-size: 11px;
            color: #6b7280;
            margin-bottom: 5px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .tiles-container {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            min-height: 50px;
            background: white;
            padding: 10px;
            border-radius: 6px;
        }

        .tile {
            width: 40px;
            height: 56px;
            background: white;
            border: 2px solid #d1d5db;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 20px;
            position: relative;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .tile:hover {
            transform: translateY(-5px);
            border-color: #3b82f6;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .tile.png-tile {
            background-size: cover;
            background-position: center;
        }

        .tile.discarded {
            opacity: 0.6;
            cursor: default;
        }

        .tile.discarded:hover {
            transform: none;
        }

        /* Hand Section */
        .hand-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .hand-section h3 {
            color: #1e3c72;
            margin-bottom: 15px;
        }

        #my-hand {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        /* Actions Panel */
        .actions-panel {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-action {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-action.discard {
            background: #3b82f6;
            color: white;
        }

        .btn-action.discard:hover {
            background: #2563eb;
        }

        .btn-action.claim {
            background: #22c55e;
            color: white;
        }

        .btn-action.claim:hover {
            background: #16a34a;
        }

        .btn-action.skip {
            background: #6b7280;
            color: white;
        }

        .btn-action.skip:hover {
            background: #4b5563;
        }

        .btn-action:disabled {
            background: #e5e7eb;
            color: #9ca3af;
            cursor: not-allowed;
        }

        /* Chat Section */
        .chat-section {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            max-height: 300px;
            display: flex;
            flex-direction: column;
        }

        .chat-section h3 {
            color: #1e3c72;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 10px;
            max-height: 200px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 10px;
        }

        .chat-message {
            margin-bottom: 8px;
            font-size: 13px;
        }

        .chat-username {
            font-weight: 600;
            color: #1e3c72;
        }

        .chat-text {
            color: #4b5563;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
        }

        .chat-input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .btn-send {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-send:hover {
            background: #2563eb;
        }

        .chat-blink {
            animation: blink 1s 3;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .modal-content h2 {
            color: #1e3c72;
            margin-bottom: 20px;
        }

        .score-breakdown {
            margin: 20px 0;
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: #f9fafb;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .breakdown-pattern {
            font-weight: 500;
        }

        .breakdown-faan {
            color: #3b82f6;
            font-weight: 600;
        }

        .score-total {
            background: #1e3c72;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: center;
        }

        .total-faan {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .total-points {
            font-size: 18px;
            opacity: 0.9;
        }

        .btn-close {
            width: 100%;
            background: #6b7280;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin-top: 20px;
        }

        .btn-close:hover {
            background: #4b5563;
        }

        /* Waiting Room */
        .waiting-room {
            text-align: center;
            padding: 40px;
        }

        .waiting-room h2 {
            color: #1e3c72;
            margin-bottom: 20px;
        }

        .waiting-players {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 30px 0;
        }

        .waiting-player {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
        }

        .waiting-player.filled {
            border-color: #22c55e;
            background: #f0fdf4;
        }

        .waiting-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-add-ai {
            flex: 1;
            background: #6b7280;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-add-ai:hover {
            background: #4b5563;
        }

        .btn-start {
            flex: 2;
            background: #22c55e;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
        }

        .btn-start:hover {
            background: #16a34a;
        }

        .btn-start:disabled {
            background: #e5e7eb;
            color: #9ca3af;
            cursor: not-allowed;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .lobby-container {
                grid-template-columns: 1fr;
            }

            .players-grid {
                grid-template-columns: 1fr 1fr;
            }

            .tile {
                width: 32px;
                height: 44px;
                font-size: 16px;
            }
        }

        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>
                ğŸ€„ HKOS Mahjong
                <span class="compliance-badge">100% HKOS</span>
            </h1>
            <div class="user-info" id="user-info" style="display: none;">
                <span class="username" id="display-username"></span>
                <button class="btn-logout" onclick="logout()">Logout</button>
            </div>
        </div>

        <!-- Authentication Section -->
        <div id="auth-section">
            <h2>Login / Register</h2>
            <div id="auth-error" class="error-message" style="display: none;"></div>
            
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" placeholder="Enter username" />
            </div>
            
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" placeholder="Enter password" />
            </div>
            
            <button class="btn-primary" onclick="login()">Login</button>
            <button class="btn-secondary" onclick="register()">Register</button>
        </div>

        <!-- Lobby Section -->
        <div id="lobby-section">
            <div class="lobby-container">
                <!-- Waiting Rooms -->
                <div class="lobby-panel">
                    <h2>ğŸ® Waiting Rooms</h2>
                    <div class="room-list" id="waiting-rooms"></div>
                    <button class="btn-create-room" onclick="createRoom()">
                        â• Create New Room
                    </button>
                </div>

                <!-- Games in Progress -->
                <div class="lobby-panel">
                    <h2>ğŸ Games in Progress</h2>
                    <div class="room-list" id="playing-games"></div>
                </div>
            </div>
        </div>

        <!-- Waiting Room Section -->
        <div id="waiting-room-section" style="display: none;">
            <div class="game-container">
                <div class="waiting-room">
                    <h2>Waiting Room</h2>
                    <p>Room ID: <strong id="current-room-id"></strong></p>
                    
                    <div class="waiting-players" id="waiting-players-grid"></div>
                    
                    <div class="waiting-actions">
                        <button class="btn-add-ai" onclick="addAI()">Add AI Player</button>
                        <button class="btn-start" id="btn-start-game" onclick="startGame()" disabled>
                            Start Game
                        </button>
                    </div>
                </div>

                <!-- Chat in Waiting Room -->
                <div class="chat-section">
                    <h3>ğŸ’¬ Chat</h3>
                    <div class="chat-messages" id="chat-messages"></div>
                    <div class="chat-input-container">
                        <input type="text" class="chat-input" id="chat-input" 
                               placeholder="Type a message..." 
                               onkeypress="handleChatEnter(event)" />
                        <button class="btn-send" onclick="sendChat()">Send</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Game Section -->
        <div id="game-section">
            <div class="game-container">
                <!-- Game Info Bar -->
                <div class="game-info-bar">
                    <div class="game-status">
                        <div class="status-item">
                            <span class="status-label">Turn</span>
                            <span class="status-value" id="turn-count">0</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Wind</span>
                            <span class="status-value" id="prevailing-wind">E</span>
                        </div>
                    </div>
                    
                    <div class="wall-counter">
                        <div class="wall-item">
                            <span class="wall-label">Live Wall</span>
                            <span class="wall-count" id="live-wall-count">120</span>
                        </div>
                        <div class="wall-item">
                            <span class="wall-label">Dead Wall</span>
                            <span class="wall-count" id="dead-wall-count">16</span>
                        </div>
                    </div>
                </div>

                <!-- Players Grid -->
                <div class="players-grid" id="players-grid"></div>

                <!-- My Hand -->
                <div class="hand-section">
                    <h3>Your Hand</h3>
                    <div class="tiles-container" id="my-hand"></div>
                    
                    <div class="actions-panel">
                        <button class="btn-action discard" id="btn-discard" onclick="discardSelected()" disabled>
                            Discard Selected
                        </button>
                        <button class="btn-action claim" id="btn-claim-win" onclick="claimWin()" style="display: none;">
                            ğŸ‰ Win!
                        </button>
                        <button class="btn-action claim" id="btn-claim-pung" onclick="claimPung()" style="display: none;">
                            Pung
                        </button>
                        <button class="btn-action skip" id="btn-skip" onclick="skipClaim()" style="display: none;">
                            Skip
                        </button>
                    </div>
                </div>

                <!-- Chat -->
                <div class="chat-section">
                    <h3>ğŸ’¬ Chat</h3>
                    <div class="chat-messages" id="game-chat-messages"></div>
                    <div class="chat-input-container">
                        <input type="text" class="chat-input" id="game-chat-input" 
                               placeholder="Type a message..." 
                               onkeypress="handleGameChatEnter(event)" />
                        <button class="btn-send" onclick="sendGameChat()">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Score Breakdown Modal -->
    <div class="modal" id="score-modal">
        <div class="modal-content">
            <h2>ğŸ‰ Game Won!</h2>
            <p><strong>Winner:</strong> <span id="winner-name"></span></p>
            
            <div class="score-breakdown" id="score-breakdown"></div>
            
            <div class="score-total">
                <div class="total-faan" id="total-faan">0 Faan</div>
                <div class="total-points" id="total-points">0 Points</div>
            </div>
            
            <button class="btn-close" onclick="closeScoreModal()">Close</button>
        </div>
    </div>

    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // GLOBAL STATE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        let socket = null;
        let userId = null;
        let username = null;
        let token = null;
        let currentRoomId = null;
        let currentGameState = null;
        let selectedTileIndex = null;

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // UTILITY FUNCTIONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showError(message) {
            const errorDiv = document.getElementById('auth-error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // AUTHENTICATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        async function login() {
            const usernameInput = document.getElementById('username').value.trim();
            const passwordInput = document.getElementById('password').value;
            
            if (!usernameInput || !passwordInput) {
                showError('Please enter username and password');
                return;
            }
            
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        username: usernameInput, 
                        password: passwordInput 
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    token = data.token;
                    userId = data.userId;
                    username = data.username;
                    localStorage.setItem('token', token);
                    
                    initializeApp();
                } else {
                    showError(data.error || 'Login failed');
                }
            } catch (error) {
                showError('Connection error');
                console.error('Login error:', error);
            }
        }

        async function register() {
            const usernameInput = document.getElementById('username').value.trim();
            const passwordInput = document.getElementById('password').value;
            
            if (!usernameInput || !passwordInput) {
                showError('Please enter username and password');
                return;
            }
            
            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        username: usernameInput, 
                        password: passwordInput 
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    token = data.token;
                    userId = data.userId;
                    username = data.username;
                    localStorage.setItem('token', token);
                    
                    initializeApp();
                } else {
                    showError(data.error || 'Registration failed');
                }
            } catch (error) {
                showError('Connection error');
                console.error('Registration error:', error);
            }
        }

        function logout() {
            if (socket) {
                socket.emit('logout');
                socket.disconnect();
            }
            
            localStorage.removeItem('token');
            token = null;
            userId = null;
            username = null;
            
            location.reload();
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // APP INITIALIZATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function initializeApp() {
            // Hide auth, show lobby
            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('lobby-section').style.display = 'block';
            document.getElementById('user-info').style.display = 'flex';
            document.getElementById('display-username').textContent = username;
            
            // Connect to socket
            socket = io();
            
            socket.on('connect', () => {
                console.log('Connected to server');
                socket.emit('authenticate', { token });
            });
            
            socket.on('authenticated', (data) => {
                if (data.success) {
                    console.log('Authenticated');
                    socket.emit('getLobbies');
                }
            });
            
            setupSocketListeners();
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SOCKET LISTENERS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function setupSocketListeners() {
            socket.on('lobbies', (data) => {
                updateLobbies(data);
            });
            
            socket.on('roomCreated', (data) => {
                currentRoomId = data.roomId;
                showWaitingRoom(data);
            });
            
            socket.on('playerJoined', (data) => {
                updateWaitingRoom(data);
            });
            
            socket.on('gameStarted', (gameState) => {
                currentGameState = gameState;
                showGame(gameState);
            });
            
            socket.on('gameState', (gameState) => {
                currentGameState = gameState;
                updateGameState(gameState);
            });
            
            socket.on('gameWon', (data) => {
                showWinModal(data);
            });
            
            socket.on('gameDraw', (data) => {
                alert('Game ended in draw: ' + data.reason);
                backToLobby();
            });
            
            socket.on('chatMessage', (data) => {
                addChatMessage(data);
            });
            
            socket.on('error', (data) => {
                alert('Error: ' + data.message);
            });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // LOBBY FUNCTIONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function updateLobbies(data) {
            const waitingDiv = document.getElementById('waiting-rooms');
            const playingDiv = document.getElementById('playing-games');
            
            // Waiting rooms
            if (data.waiting.length === 0) {
                waitingDiv.innerHTML = '<p style="color: #6b7280; padding: 20px; text-align: center;">No waiting rooms. Create one!</p>';
            } else {
                waitingDiv.innerHTML = data.waiting.map(room => `
                    <div class="room-item" onclick="joinRoom('${room.roomId}')">
                        <div class="room-header">
                            <span class="room-id">Room ${room.roomId.substring(5, 13)}</span>
                            <span class="player-count">${room.playerCount}/4</span>
                        </div>
                        <div class="room-players">
                            ${room.players.map(p => 
                                `<span class="player-chip ${p.isAI ? 'ai' : ''}">${escapeHtml(p.name)}</span>`
                            ).join('')}
                        </div>
                    </div>
                `).join('');
            }
            
            // Games in progress
            if (data.playing.length === 0) {
                playingDiv.innerHTML = '<p style="color: #6b7280; padding: 20px; text-align: center;">No games in progress</p>';
            } else {
                playingDiv.innerHTML = data.playing.map(room => `
                    <div class="room-item" style="cursor: default;">
                        <div class="room-header">
                            <span class="room-id">Game ${room.roomId.substring(5, 13)}</span>
                            <span class="player-count">Turn ${room.turnCount}</span>
                        </div>
                        <div class="room-players">
                            ${room.players.map(p => 
                                `<span class="player-chip ${p.isAI ? 'ai' : ''}">${escapeHtml(p.name)}</span>`
                            ).join('')}
                        </div>
                    </div>
                `).join('');
            }
        }

        function createRoom() {
            socket.emit('createRoom');
        }

        function joinRoom(roomId) {
            socket.emit('joinRoom', { roomId });
            currentRoomId = roomId;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // WAITING ROOM
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function showWaitingRoom(data) {
            document.getElementById('lobby-section').style.display = 'none';
            document.getElementById('waiting-room-section').style.display = 'block';
            document.getElementById('current-room-id').textContent = data.roomId.substring(5, 13);
            updateWaitingRoom(data);
        }

        function updateWaitingRoom(data) {
            const grid = document.getElementById('waiting-players-grid');
            grid.innerHTML = '';
            
            for (let i = 0; i < 4; i++) {
                const player = data.players[i];
                const div = document.createElement('div');
                div.className = 'waiting-player' + (player ? ' filled' : '');
                div.innerHTML = player 
                    ? `<strong>${escapeHtml(player.name)}</strong><br>${player.isAI ? 'ğŸ¤– AI' : 'ğŸ‘¤ Human'}`
                    : 'â³ Waiting...';
                grid.appendChild(div);
            }
            
            document.getElementById('btn-start-game').disabled = data.playerCount < 2;
        }

        function addAI() {
            socket.emit('addAI');
        }

        function startGame() {
            socket.emit('startGame');
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // GAME DISPLAY
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function showGame(gameState) {
            document.getElementById('waiting-room-section').style.display = 'none';
            document.getElementById('game-section').style.display = 'block';
            updateGameState(gameState);
        }

        function updateGameState(gameState) {
            // Update info bar
            document.getElementById('turn-count').textContent = gameState.turnCount;
            document.getElementById('prevailing-wind').textContent = gameState.prevailingWind;
            document.getElementById('live-wall-count').textContent = gameState.liveWallCount;
            document.getElementById('dead-wall-count').textContent = gameState.deadWallCount;
            
            // Update players grid
            const playersGrid = document.getElementById('players-grid');
            playersGrid.innerHTML = gameState.players.map((player, index) => `
                <div class="player-box ${index === gameState.currentPlayer ? 'active' : ''} ${player.isYou ? 'you' : ''}">
                    <div class="player-header">
                        <div>
                            <div class="player-name ${player.isAI ? 'ai' : ''}">
                                ${escapeHtml(player.name)} ${player.isYou ? '(You)' : ''}
                            </div>
                            <div class="furiten-badge ${player.isFuriten ? 'active' : ''}">
                                ğŸš« Furiten
                            </div>
                        </div>
                        <span class="player-wind">${player.wind}</span>
                    </div>
                    <div class="player-stats">
                        <div class="stat-item">
                            <span>Concealed:</span>
                            <span>${player.concealedCount}</span>
                        </div>
                        <div class="stat-item">
                            <span>Exposed:</span>
                            <span>${player.exposed.length}</span>
                        </div>
                        <div class="stat-item">
                            <span>Discards:</span>
                            <span>${player.discards.length}</span>
                        </div>
                    </div>
                    <div class="tiles-section">
                        <div class="section-label">Discards</div>
                        <div class="tiles-container">
                            ${player.discards.slice(-5).map(tile => renderTile(tile, true)).join('')}
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Update my hand
            const myPlayer = gameState.players.find(p => p.isYou);
            if (myPlayer && myPlayer.concealed) {
                const myHand = document.getElementById('my-hand');
                myHand.innerHTML = myPlayer.concealed.map((tile, index) => 
                    renderTile(tile, false, index)
                ).join('');
            }
            
            // Update action buttons
            const isMyTurn = gameState.players[gameState.currentPlayer]?.isYou;
            document.getElementById('btn-discard').disabled = !isMyTurn || selectedTileIndex === null;
            
            // Show/hide claim buttons
            const canClaim = gameState.canClaim;
            document.getElementById('btn-claim-win').style.display = canClaim ? 'block' : 'none';
            document.getElementById('btn-skip').style.display = canClaim ? 'block' : 'none';
        }

        function renderTile(tile, isDiscarded = false, index = null) {
            const tileText = tile.type === 'SUITED' 
                ? tile.rank + tile.suit[0]
                : tile.rank;
            
            const clickHandler = index !== null ? `onclick="selectTile(${index})"` : '';
            const classes = `tile ${isDiscarded ? 'discarded' : ''}`;
            
            return `<div class="${classes}" ${clickHandler} data-tile="${tileText}">${tileText}</div>`;
        }

        function selectTile(index) {
            selectedTileIndex = index;
            
            // Visual feedback
            const tiles = document.querySelectorAll('#my-hand .tile');
            tiles.forEach((tile, i) => {
                if (i === index) {
                    tile.style.borderColor = '#22c55e';
                    tile.style.borderWidth = '3px';
                } else {
                    tile.style.borderColor = '#d1d5db';
                    tile.style.borderWidth = '2px';
                }
            });
            
            document.getElementById('btn-discard').disabled = false;
        }

        function discardSelected() {
            if (selectedTileIndex === null) return;
            
            socket.emit('discardTile', { tileIndex: selectedTileIndex });
            selectedTileIndex = null;
        }

        function claimWin() {
            socket.emit('claimTile', { claimType: 'WIN' });
        }

        function claimPung() {
            socket.emit('claimTile', { claimType: 'PUNG' });
        }

        function skipClaim() {
            socket.emit('skipClaim');
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CHAT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function addChatMessage(data) {
            const messagesDiv = document.getElementById('chat-messages');
            const gameMessagesDiv = document.getElementById('game-chat-messages');
            
            const messageHtml = `
                <div class="chat-message">
                    <span class="chat-username">${escapeHtml(data.username)}:</span>
                    <span class="chat-text">${escapeHtml(data.message)}</span>
                </div>
            `;
            
            if (messagesDiv) {
                messagesDiv.innerHTML += messageHtml;
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
                messagesDiv.classList.add('chat-blink');
                setTimeout(() => messagesDiv.classList.remove('chat-blink'), 3000);
            }
            
            if (gameMessagesDiv) {
                gameMessagesDiv.innerHTML += messageHtml;
                gameMessagesDiv.scrollTop = gameMessagesDiv.scrollHeight;
                gameMessagesDiv.classList.add('chat-blink');
                setTimeout(() => gameMessagesDiv.classList.remove('chat-blink'), 3000);
            }
        }

        function sendChat() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;
            
            socket.emit('chatMessage', { message });
            input.value = '';
        }

        function sendGameChat() {
            const input = document.getElementById('game-chat-input');
            const message = input.value.trim();
            if (!message) return;
            
            socket.emit('chatMessage', { message });
            input.value = '';
        }

        function handleChatEnter(event) {
            if (event.key === 'Enter') sendChat();
        }

        function handleGameChatEnter(event) {
            if (event.key === 'Enter') sendGameChat();
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // WIN MODAL
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function showWinModal(data) {
            document.getElementById('winner-name').textContent = data.winner;
            
            const breakdownDiv = document.getElementById('score-breakdown');
            breakdownDiv.innerHTML = data.breakdown.map(item => `
                <div class="breakdown-item">
                    <span class="breakdown-pattern">${escapeHtml(item.pattern)}</span>
                    <span class="breakdown-faan">+${item.faan} Faan</span>
                </div>
            `).join('');
            
            document.getElementById('total-faan').textContent = data.faan + ' Faan';
            document.getElementById('total-points').textContent = data.points + ' Points';
            
            document.getElementById('score-modal').classList.add('active');
        }

        function closeScoreModal() {
            document.getElementById('score-modal').classList.remove('active');
            backToLobby();
        }

        function backToLobby() {
            document.getElementById('game-section').style.display = 'none';
            document.getElementById('waiting-room-section').style.display = 'none';
            document.getElementById('lobby-section').style.display = 'block';
            
            currentRoomId = null;
            currentGameState = null;
            selectedTileIndex = null;
            
            socket.emit('getLobbies');
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // INIT ON PAGE LOAD
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        window.addEventListener('load', () => {
            const savedToken = localStorage.getItem('token');
            if (savedToken) {
                token = savedToken;
                // Auto-login would require validating token first
                // For now, just show login screen
            }
        });
    </script>
</body>
</html>
