<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Mahjong Online</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&family=Ma+Shan+Zheng&display=swap');
    
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Noto Sans SC',-apple-system,BlinkMacSystemFont,sans-serif;background:#f5f0e6;color:#2c2c2c;min-height:100vh}
    .screen{display:none;min-height:100vh}
    .screen.active{display:flex;flex-direction:column}
    
    /* Loading */
    #loading{justify-content:center;align-items:center;background:linear-gradient(135deg,#f5f0e6 0%,#e8e0d0 100%)}
    .loader{text-align:center}
    .loader-tile{font-size:80px;animation:bounce 1s infinite}
    @keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-20px)}}
    .loader p{margin-top:20px;color:#666;font-size:18px}
    
    /* Auth */
    #auth{justify-content:center;align-items:center;padding:20px;background:linear-gradient(135deg,#f5f0e6 0%,#e8e0d0 100%)}
    .auth-box{background:#fff;border-radius:20px;padding:30px;width:100%;max-width:380px;box-shadow:0 10px 40px rgba(0,0,0,0.1);border:2px solid #d4c4a8}
    .auth-box h1{text-align:center;font-size:28px;margin-bottom:25px;color:#8b0000}
    .auth-box h1 span{font-size:48px;display:block;margin-bottom:10px}
    .tabs{display:flex;margin-bottom:20px;background:#f5f0e6;border-radius:10px;padding:4px}
    .tabs button{flex:1;padding:12px;border:none;background:none;color:#666;font-size:15px;cursor:pointer;border-radius:8px;transition:all 0.3s;font-family:inherit}
    .tabs button.active{background:#8b0000;color:#fff}
    .form{display:none;flex-direction:column;gap:15px}
    .form.active{display:flex}
    .form input{padding:15px;border:2px solid #d4c4a8;border-radius:10px;background:#faf8f5;color:#333;font-size:16px;font-family:inherit}
    .form input:focus{outline:none;border-color:#8b0000}
    .form input::placeholder{color:#999}
    .btn{padding:15px 25px;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;transition:all 0.3s;font-family:inherit}
    .btn-primary{background:linear-gradient(135deg,#8b0000,#a52a2a);color:#fff}
    .btn-primary:hover{transform:translateY(-2px);box-shadow:0 5px 20px rgba(139,0,0,0.3)}
    .error-msg{color:#8b0000;font-size:14px;text-align:center;min-height:20px}
    
    /* Lobby */
    #lobby{background:#f5f0e6}
    .header{display:flex;justify-content:space-between;align-items:center;padding:15px 20px;background:#fff;border-bottom:2px solid #d4c4a8}
    .header .user{font-weight:600;color:#333}
    .header .user span{margin-right:8px}
    .btn-small{padding:8px 15px;font-size:14px;background:#f5f0e6;color:#666;border:2px solid #d4c4a8;border-radius:8px;cursor:pointer;font-family:inherit}
    .btn-small:hover{background:#e8e0d0}
    .lobby-body{padding:20px;max-width:500px;margin:0 auto;width:100%}
    .create-join{display:flex;flex-direction:column;gap:12px;margin-bottom:30px}
    .btn-large{padding:18px;font-size:18px;width:100%}
    .join-row{display:flex;gap:10px}
    .join-row input{flex:1;padding:15px;font-size:20px;text-align:center;letter-spacing:8px;text-transform:uppercase;background:#fff;border:2px solid #d4c4a8;border-radius:10px;color:#333;font-family:inherit}
    .join-row input:focus{outline:none;border-color:#8b0000}
    .join-row .btn{padding:15px 25px}
    .section{margin-bottom:25px}
    .section h2{font-size:14px;color:#666;text-transform:uppercase;letter-spacing:1px;margin-bottom:12px}
    .room-list{display:flex;flex-direction:column;gap:10px}
    .room-card{display:flex;justify-content:space-between;align-items:center;padding:18px;background:#fff;border-radius:12px;cursor:pointer;transition:all 0.3s;border:2px solid #d4c4a8}
    .room-card:hover{border-color:#8b0000;transform:translateX(5px)}
    .room-card .code{font-size:22px;font-weight:700;color:#8b0000;letter-spacing:3px}
    .room-card .count{color:#666}
    .empty{color:#999;text-align:center;padding:30px;background:#fff;border-radius:12px;border:2px solid #d4c4a8}
    .lb-list{background:#fff;border-radius:12px;overflow:hidden;border:2px solid #d4c4a8}
    .lb-row{display:grid;grid-template-columns:40px 1fr 80px;padding:14px 18px;border-bottom:1px solid #e8e0d0}
    .lb-row:last-child{border:none}
    .lb-row .rank{color:#8b0000;font-weight:700}
    .lb-row .score{text-align:right;color:#666}
    
    /* Waiting */
    #waiting{justify-content:center;align-items:center;padding:20px;background:#f5f0e6}
    .wait-box{background:#fff;border-radius:20px;padding:30px;width:100%;max-width:420px;text-align:center;border:2px solid #d4c4a8;box-shadow:0 10px 40px rgba(0,0,0,0.1)}
    .wait-box h2{font-size:24px;margin-bottom:25px;color:#333}
    .wait-box h2 span{color:#8b0000;letter-spacing:4px}
    .seats{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:25px}
    .seat{padding:20px;background:#f5f0e6;border-radius:12px;border:2px solid #d4c4a8}
    .seat.filled{border-color:#228b22;background:#f0fff0}
    .seat.me{border-color:#8b0000;background:#fff5f5}
    .seat .wind{font-size:13px;color:#666;margin-bottom:5px}
    .seat .name{font-size:16px;font-weight:500;color:#333}
    .seat .name.empty{color:#999}
    .wait-box .btn{margin-top:10px;width:100%}
    .btn-ai{background:linear-gradient(135deg,#4a90d9,#357abd);color:#fff;border:none}
    
    /* Game */
    #game{background:#2d5a2d;position:relative}
    .game-header{position:fixed;top:0;left:0;right:0;display:flex;justify-content:space-between;padding:10px 15px;z-index:50}
    .btn-leave,.btn-chat-toggle{padding:8px 14px;font-size:12px;background:rgba(255,255,255,0.9);border:none;border-radius:8px;cursor:pointer;font-family:inherit;color:#333;box-shadow:0 2px 8px rgba(0,0,0,0.2)}
    .btn-leave:hover,.btn-chat-toggle:hover{background:#fff}
    .btn-leave{color:#8b0000}
    .game-container{flex:1;position:relative;max-width:100%;overflow:hidden;background:linear-gradient(135deg,#2d5a2d 0%,#1e4620 100%);padding-top:50px}
    .opp{position:absolute;display:flex;flex-direction:column;align-items:center}
    .opp.top{top:10px;left:50%;transform:translateX(-50%)}
    .opp.left{left:10px;top:50%;transform:translateY(-50%)}
    .opp.right{right:10px;top:50%;transform:translateY(-50%)}
    .opp-name{font-size:12px;color:#fff;margin-bottom:5px;background:rgba(0,0,0,0.5);padding:4px 12px;border-radius:10px}
    .opp-tiles{display:flex;gap:2px}
    .opp.left .opp-tiles,.opp.right .opp-tiles{flex-direction:column}
    .back-tile{width:30px;height:42px;background:linear-gradient(145deg,#1e88e5,#1565c0);border-radius:4px;border:1px solid #0d47a1;box-shadow:inset 0 0 10px rgba(255,255,255,0.2)}
    .opp.left .back-tile,.opp.right .back-tile{width:42px;height:30px}
    .opp-melds{display:flex;gap:6px;margin-top:6px}
    .center-area{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center}
    .game-info{display:flex;gap:20px;justify-content:center;align-items:center;margin-bottom:15px}
    .game-info .wind{font-size:36px;color:#ffd700;text-shadow:0 2px 4px rgba(0,0,0,0.3)}
    .game-info .wall{color:#fff;font-size:14px;background:rgba(0,0,0,0.3);padding:5px 12px;border-radius:15px}
    .discard-pile{display:flex;flex-wrap:wrap;gap:3px;justify-content:center;max-width:280px;padding:15px;background:rgba(139,90,43,0.6);border-radius:12px;min-height:80px;border:2px solid rgba(139,90,43,0.8)}
    .discard-pile .tile{width:34px;height:46px;font-size:26px;cursor:default}
    .discard-pile .tile:hover{transform:none}
    .last-discard{margin-top:15px}
    .last-discard .tile{width:58px;height:78px;font-size:46px;border:3px solid #ffd700;box-shadow:0 0 20px rgba(255,215,0,0.6);animation:pulse 1s infinite;cursor:default}
    .last-discard .tile:hover{transform:none}
    @keyframes pulse{0%,100%{box-shadow:0 0 20px rgba(255,215,0,0.6)}50%{box-shadow:0 0 30px rgba(255,215,0,0.9)}}
    .my-section{position:absolute;bottom:75px;left:50%;transform:translateX(-50%);display:flex;flex-direction:column;align-items:center;width:95%;max-width:580px}
    .my-melds{display:flex;gap:10px;margin-bottom:10px}
    .meld{display:flex;gap:2px;background:rgba(0,0,0,0.3);padding:6px;border-radius:8px}
    .meld .tile{width:40px;height:54px;font-size:30px;cursor:default}
    .meld .tile:hover{transform:none}
    .my-hand{display:flex;flex-wrap:wrap;gap:5px;justify-content:center;padding:15px;background:rgba(0,0,0,0.3);border-radius:15px}
    .my-info{margin-top:10px;font-size:14px;color:#fff;background:rgba(0,0,0,0.3);padding:5px 15px;border-radius:10px}
    
    /* Tiles - Traditional Style (Larger) */
    .tile{
      width:52px;height:72px;
      background:linear-gradient(145deg,#fffff8,#f0ead6);
      border:2px solid #b8a88a;
      border-radius:6px;
      display:flex;align-items:center;justify-content:center;
      font-size:42px;
      cursor:pointer;
      transition:transform 0.15s,box-shadow 0.15s;
      user-select:none;
      box-shadow:2px 2px 4px rgba(0,0,0,0.2),inset 0 0 20px rgba(255,255,255,0.5);
      position:relative;
    }
    .tile:hover{transform:translateY(-8px);box-shadow:2px 6px 12px rgba(0,0,0,0.3)}
    .tile.selected{transform:translateY(-12px);border-color:#ffd700;box-shadow:0 8px 25px rgba(255,215,0,0.5)}
    
    /* Action Buttons */
    .actions{position:fixed;bottom:0;left:0;right:0;display:flex;justify-content:center;gap:8px;padding:12px;background:linear-gradient(to top,rgba(30,70,32,0.95) 0%,transparent 100%)}
    .actions .btn{
      padding:12px 16px;font-size:14px;
      background:linear-gradient(145deg,#fff,#f0ead6);
      border:2px solid #b8a88a;color:#333;
      font-family:'Ma Shan Zheng','Noto Sans SC',sans-serif;
      display:flex;flex-direction:column;align-items:center;gap:2px;
      min-width:65px;
    }
    .actions .btn .cn{font-size:18px;color:#8b0000}
    .actions .btn .en{font-size:10px;color:#666}
    .actions .btn:disabled{opacity:0.4;cursor:not-allowed}
    .actions .btn-win{background:linear-gradient(145deg,#ffe4e4,#ffd0d0);border-color:#8b0000}
    .actions .btn-win .cn{color:#8b0000;font-size:20px}
    .actions .btn-skip{background:rgba(255,255,255,0.2);border-color:rgba(255,255,255,0.3);color:#fff}
    .actions .btn-skip .cn{color:#fff}
    .actions .btn-skip .en{color:rgba(255,255,255,0.7)}
    .turn-indicator{position:fixed;top:60px;left:50%;transform:translateX(-50%);padding:10px 25px;background:linear-gradient(135deg,#ffd700,#ffb300);color:#333;font-weight:700;border-radius:25px;opacity:0;transition:opacity 0.3s;box-shadow:0 4px 15px rgba(255,215,0,0.4);font-family:'Ma Shan Zheng',sans-serif;font-size:18px}
    .turn-indicator.show{opacity:1}
    
    /* Chat Panel */
    .chat-panel{position:fixed;right:-320px;top:50px;width:300px;height:calc(100vh - 120px);background:#fff;border-radius:12px 0 0 12px;box-shadow:-4px 0 20px rgba(0,0,0,0.3);transition:right 0.3s;z-index:60;display:flex;flex-direction:column}
    .chat-panel.open{right:0}
    .chat-header{display:flex;justify-content:space-between;align-items:center;padding:12px 15px;background:#f5f0e6;border-radius:12px 0 0 0;border-bottom:1px solid #d4c4a8}
    .chat-header span{font-weight:600;color:#333}
    .chat-header button{background:none;border:none;font-size:18px;cursor:pointer;color:#666}
    .chat-messages{flex:1;overflow-y:auto;padding:10px;display:flex;flex-direction:column;gap:8px}
    .chat-msg{padding:8px 12px;background:#f5f0e6;border-radius:10px;font-size:13px}
    .chat-msg .name{font-weight:600;color:#8b0000;font-size:11px;margin-bottom:2px}
    .chat-msg .text{color:#333}
    .chat-msg .time{font-size:10px;color:#999;margin-top:2px}
    .chat-input{display:flex;gap:8px;padding:10px;border-top:1px solid #d4c4a8}
    .chat-input input{flex:1;padding:10px;border:1px solid #d4c4a8;border-radius:8px;font-size:14px;font-family:inherit}
    .chat-input input:focus{outline:none;border-color:#8b0000}
    .chat-input button{padding:10px 15px;background:#8b0000;color:#fff;border:none;border-radius:8px;cursor:pointer;font-family:inherit}
    
    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.8);display:none;justify-content:center;align-items:center;padding:20px;z-index:100}
    .modal.active{display:flex}
    .modal-content{background:#fff;border-radius:20px;padding:35px;text-align:center;max-width:450px;width:100%;border:3px solid #d4c4a8}
    .modal-content h2{font-size:26px;margin-bottom:10px;color:#8b0000}
    .modal-content .score-big{font-size:48px;color:#8b0000;font-weight:700;margin:15px 0;font-family:'Ma Shan Zheng',sans-serif}
    .win-tiles{display:flex;flex-wrap:wrap;gap:5px;justify-content:center;margin:20px 0;padding:15px;background:#f5f0e6;border-radius:12px}
    .win-tiles .tile{width:42px;height:56px;font-size:30px;cursor:default}
    .win-tiles .tile:hover{transform:none}
    
    /* Music Toggle */
    .music-toggle{position:fixed;top:10px;right:10px;z-index:60;padding:8px 12px;background:rgba(255,255,255,0.9);border:none;border-radius:8px;cursor:pointer;font-size:16px}
    
    /* Responsive - Use viewport units for fluid scaling */
    @media(max-width:900px){
      .tile{width:calc(6vw + 10px);height:calc(8vw + 14px);font-size:calc(4vw + 8px)}
      .meld .tile{width:calc(5vw + 6px);height:calc(7vw + 8px);font-size:calc(3.5vw + 6px)}
      .discard-pile .tile{width:calc(4vw + 4px);height:calc(5.5vw + 6px);font-size:calc(3vw + 4px)}
      .discard-pile{max-width:50vw;padding:10px}
      .back-tile{width:calc(3vw + 6px);height:calc(4vw + 10px)}
      .opp.left .back-tile,.opp.right .back-tile{width:calc(4vw + 10px);height:calc(3vw + 6px)}
      .last-discard .tile{width:calc(7vw + 12px);height:calc(9vw + 16px);font-size:calc(5vw + 10px)}
      .my-hand{padding:10px;gap:3px}
      .my-section{bottom:70px;width:98%}
      .actions .btn{padding:8px 10px;min-width:calc(10vw + 20px)}
      .actions .btn .cn{font-size:calc(2vw + 10px)}
      .actions .btn .en{font-size:calc(1vw + 6px)}
      .game-info .wind{font-size:calc(4vw + 12px)}
      .game-info .wall{font-size:calc(1.5vw + 8px)}
      .opp-name{font-size:calc(1.2vw + 8px);padding:3px 8px}
      .center-area{top:45%}
    }
    
    @media(max-width:600px){
      .tile{width:calc(8vw + 6px);height:calc(11vw + 8px);font-size:calc(6vw + 4px)}
      .meld .tile{width:calc(6vw + 4px);height:calc(8vw + 6px);font-size:calc(4.5vw + 2px)}
      .discard-pile .tile{width:calc(5vw + 2px);height:calc(7vw + 3px);font-size:calc(4vw + 1px)}
      .discard-pile{max-width:60vw;min-height:60px;padding:8px}
      .back-tile{width:calc(4vw + 4px);height:calc(5.5vw + 6px)}
      .opp.left .back-tile,.opp.right .back-tile{width:calc(5.5vw + 6px);height:calc(4vw + 4px)}
      .last-discard .tile{width:calc(9vw + 8px);height:calc(12vw + 10px);font-size:calc(7vw + 6px)}
      .my-section{bottom:65px}
      .actions{padding:8px;gap:5px}
      .actions .btn{padding:6px 8px;min-width:auto}
      .actions .btn .cn{font-size:14px}
      .actions .btn .en{font-size:8px}
      .opp.top{top:55px}
      .opp.left{left:5px}
      .opp.right{right:5px}
      .game-header{padding:8px 10px}
      .btn-leave,.btn-chat-toggle{padding:6px 10px;font-size:11px}
      .center-area{top:42%}
      .win-tiles .tile{width:calc(7vw + 8px);height:calc(9vw + 10px);font-size:calc(5vw + 6px)}
    }
    
    @media(max-width:400px){
      .tile{width:calc(9vw + 4px);height:calc(12vw + 6px);font-size:calc(7vw + 2px)}
      .meld .tile{width:calc(7vw + 2px);height:calc(9vw + 4px);font-size:calc(5vw)}
      .discard-pile .tile{width:calc(6vw);height:calc(8vw + 2px);font-size:calc(5vw)}
      .discard-pile{max-width:70vw}
      .back-tile{width:calc(5vw + 2px);height:calc(6.5vw + 4px)}
      .opp.left .back-tile,.opp.right .back-tile{width:calc(6.5vw + 4px);height:calc(5vw + 2px)}
      .last-discard .tile{width:calc(10vw + 6px);height:calc(13vw + 8px);font-size:calc(8vw + 4px)}
      .actions .btn .cn{font-size:12px}
      .actions .btn .en{font-size:7px}
      .my-section{bottom:60px}
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Loading -->
    <div id="loading" class="screen active">
      <div class="loader">
        <div class="loader-tile">üÄÑ</div>
        <p>Loading...</p>
      </div>
    </div>

    <!-- Auth -->
    <div id="auth" class="screen">
      <div class="auth-box">
        <h1><span>üÄÑ</span>È∫ªÂ∞á Mahjong</h1>
        <div class="tabs">
          <button class="active" onclick="showTab('login')">ÁôªÂÖ• Login</button>
          <button onclick="showTab('register')">Ë®ªÂÜä Register</button>
        </div>
        <form id="login-form" class="form active" onsubmit="doLogin(event)">
          <input type="text" id="l-user" placeholder="Username Áî®Êà∂Âêç" required>
          <input type="password" id="l-pass" placeholder="Password ÂØÜÁ¢º" required>
          <button type="submit" class="btn btn-primary">ÁôªÂÖ• Login</button>
          <div class="error-msg" id="l-err"></div>
        </form>
        <form id="register-form" class="form" onsubmit="doRegister(event)">
          <input type="text" id="r-user" placeholder="Username Áî®Êà∂Âêç (3+ chars)" required minlength="3">
          <input type="text" id="r-name" placeholder="Display Name È°ØÁ§∫ÂêçÁ®±" required>
          <input type="password" id="r-pass" placeholder="Password ÂØÜÁ¢º (4+ chars)" required minlength="4">
          <button type="submit" class="btn btn-primary">Ë®ªÂÜä Create Account</button>
          <div class="error-msg" id="r-err"></div>
        </form>
      </div>
    </div>

    <!-- Lobby -->
    <div id="lobby" class="screen">
      <div class="header">
        <div class="user"><span>üÄÑ</span><span id="my-name">Player</span></div>
        <button class="btn-small" onclick="doLogout()">ÁôªÂá∫ Logout</button>
      </div>
      <div class="lobby-body">
        <div class="create-join">
          <button class="btn btn-primary btn-large" onclick="createRoom()">ÈñãÊàø Create Room</button>
          <div class="join-row">
            <input type="text" id="join-code" placeholder="CODE" maxlength="4">
            <button class="btn btn-primary" onclick="joinRoom()">Âä†ÂÖ• Join</button>
          </div>
        </div>
        <div class="section">
          <h2>ÈñãÊîæÊàøÈñì Open Rooms</h2>
          <div id="rooms" class="room-list"></div>
        </div>
        <div class="section">
          <h2>ÊéíË°åÊ¶ú Leaderboard</h2>
          <div id="lb" class="lb-list"></div>
        </div>
      </div>
    </div>

    <!-- Waiting -->
    <div id="waiting" class="screen">
      <div class="wait-box">
        <h2>ÊàøÈñì Room: <span id="room-code">XXXX</span></h2>
        <div id="seats" class="seats"></div>
        <button id="start-btn" class="btn btn-primary" onclick="startGame()" disabled>Á≠âÂæÖÁé©ÂÆ∂ Waiting...</button>
        <button id="ai-btn" class="btn btn-ai" onclick="startWithAI()">ü§ñ ËàáÈõªËÖ¶Â∞çÊà∞ Play with AI</button>
        <button class="btn btn-small" onclick="leaveRoom()">Èõ¢Èñã Leave</button>
      </div>
    </div>

    <!-- Game -->
    <div id="game" class="screen">
      <div class="game-header">
        <button class="btn-leave" onclick="leaveGame()">‚úï Èõ¢Èñã Leave</button>
        <div>
          <button class="btn-chat-toggle" onclick="toggleMusic()" id="music-btn">üîá</button>
          <button class="btn-chat-toggle" onclick="toggleChat()">üí¨</button>
        </div>
      </div>
      <audio id="bg-music" loop>
        <source src="https://upload.wikimedia.org/wikipedia/commons/5/5a/Guzheng-chinesezither.ogg" type="audio/ogg">
      </audio>
      <div class="game-container">
        <div class="opp top" id="opp-top">
          <div class="opp-name"></div>
          <div class="opp-tiles"></div>
          <div class="opp-melds"></div>
        </div>
        <div class="opp left" id="opp-left">
          <div class="opp-name"></div>
          <div class="opp-tiles"></div>
          <div class="opp-melds"></div>
        </div>
        <div class="opp right" id="opp-right">
          <div class="opp-name"></div>
          <div class="opp-tiles"></div>
          <div class="opp-melds"></div>
        </div>
        <div class="center-area">
          <div class="game-info">
            <span class="wind" id="round-wind">Êù±</span>
            <span class="wall">È§òÁâå <span id="wall-count">144</span></span>
          </div>
          <div id="discards" class="discard-pile"></div>
          <div id="last" class="last-discard"></div>
        </div>
        <div class="my-section">
          <div id="my-melds" class="my-melds"></div>
          <div id="my-hand" class="my-hand"></div>
          <div class="my-info" id="my-info"></div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" id="btn-chow" onclick="claimChow()" disabled>
          <span class="cn">ÂêÉ</span><span class="en">Chow</span>
        </button>
        <button class="btn" id="btn-pung" onclick="claimPung()" disabled>
          <span class="cn">Á¢∞</span><span class="en">Pung</span>
        </button>
        <button class="btn" id="btn-kong" onclick="claimKong()" disabled>
          <span class="cn">Êßì</span><span class="en">Kong</span>
        </button>
        <button class="btn btn-win" id="btn-mj" onclick="claimMahjong()" disabled>
          <span class="cn">ËÉ°</span><span class="en">Mahjong</span>
        </button>
        <button class="btn btn-skip" onclick="skip()">
          <span class="cn">ÈÅé</span><span class="en">Skip</span>
        </button>
      </div>
      <div class="turn-indicator" id="turn-ind">Ëº™Âà∞‰Ω†‰∫Ü Your Turn</div>
      
      <!-- Chat Panel -->
      <div id="chat-panel" class="chat-panel">
        <div class="chat-header">
          <span>üí¨ ËÅäÂ§© Chat</span>
          <button onclick="toggleChat()">‚úï</button>
        </div>
        <div id="chat-messages" class="chat-messages"></div>
        <div class="chat-input">
          <input type="text" id="chat-text" placeholder="Ëº∏ÂÖ•Ë®äÊÅØ Type message..." maxlength="200" onkeypress="if(event.key==='Enter')sendChat()">
          <button onclick="sendChat()">ÁôºÈÄÅ</button>
        </div>
      </div>
    </div>

    <!-- Win Modal -->
    <div id="win-modal" class="modal">
      <div class="modal-content">
        <h2>üéâ <span id="winner-name">Player</span> ËÉ°Áâå!</h2>
        <div class="score-big"><span id="win-score">0</span> ÂàÜ</div>
        <div id="win-hand" class="win-tiles"></div>
        <button class="btn btn-primary" onclick="backToLobby()">ËøîÂõûÂ§ßÂª≥ Back to Lobby</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    let socket, user, currentRoom, gameState, selectedTiles = [];

    const $=id=>document.getElementById(id);
    const show=id=>{document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));$(id).classList.add('active')};
    const api=async(url,opts={})=>{const r=await fetch(url,{...opts,headers:{'Content-Type':'application/json'},credentials:'include'});return r.json()};

    function showTab(tab){
      document.querySelectorAll('.tabs button').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('.form').forEach(f=>f.classList.remove('active'));
      event.target.classList.add('active');
      $(tab+'-form').classList.add('active');
    }

    async function doLogin(e){
      e.preventDefault();
      const d=await api('/api/login',{method:'POST',body:JSON.stringify({username:$('l-user').value,password:$('l-pass').value})});
      if(d.success){user=d.user;localStorage.setItem('token',d.token);initSocket();showLobby()}
      else $('l-err').textContent=d.error||'Login failed';
    }

    async function doRegister(e){
      e.preventDefault();
      const d=await api('/api/register',{method:'POST',body:JSON.stringify({username:$('r-user').value,displayName:$('r-name').value,password:$('r-pass').value})});
      if(d.success){user=d.user;localStorage.setItem('token',d.token);initSocket();showLobby()}
      else $('r-err').textContent=d.error||'Registration failed';
    }

    function doLogout(){api('/api/logout',{method:'POST'});localStorage.removeItem('token');user=null;if(socket)socket.disconnect();show('auth')}

    async function checkAuth(){
      try{const d=await api('/api/me');if(d.user){user=d.user;initSocket();showLobby();return true}}catch{}
      show('auth');return false;
    }

    function initSocket(){
      socket=io();
      socket.on('connect',()=>{const t=localStorage.getItem('token');if(t)socket.emit('auth',t,r=>{if(!r.success)doLogout()})});
      socket.on('lobbyCreated',loadRooms);
      socket.on('lobbyUpdated',loadRooms);
      socket.on('lobbyRemoved',loadRooms);
      socket.on('playerJoined',d=>updateSeats(d.players||[]));
      socket.on('playerLeft',d=>updateSeats(d.players||[]));
      socket.on('readyToStart',d=>{updateSeats(d.players);$('start-btn').disabled=false;$('start-btn').textContent='ÈñãÂßã Start Game!'});
      socket.on('gameStarted',d=>{gameState=d;show('game');renderGame()});
      socket.on('stateUpdate',d=>{gameState=d;renderGame()});
      socket.on('gameWon',handleWin);
      socket.on('gameDraw',()=>{alert('ÊµÅÂ±Ä Draw!');backToLobby()});
      socket.on('chat',d=>addChatMessage(d));
    }

    function showLobby(){show('lobby');$('my-name').textContent=user.displayName;loadRooms();loadLeaderboard()}

    async function loadRooms(){
      const d=await api('/api/lobbies');
      $('rooms').innerHTML=d.length?d.map(r=>`<div class="room-card" onclick="joinRoomByCode('${r.roomCode}')"><span class="code">${r.roomCode}</span><span class="count">${r.playerCount}/4</span></div>`).join(''):'<div class="empty">Ê≤íÊúâÈñãÊîæÊàøÈñì No open rooms</div>';
    }

    async function loadLeaderboard(){
      const d=await api('/api/leaderboard');
      $('lb').innerHTML=d.length?d.slice(0,8).map((p,i)=>`<div class="lb-row"><span class="rank">${i+1}</span><span>${p.display_name}</span><span class="score">${p.total_score}</span></div>`).join(''):'<div class="empty">Êö´ÁÑ°Ë®òÈåÑ No games yet</div>';
    }

    function createRoom(){socket.emit('createRoom',r=>{if(r.success){currentRoom=r.roomCode;showWaiting(r)}else alert(r.error||'Failed')})}
    function joinRoom(){const c=$('join-code').value.toUpperCase();if(c)joinRoomByCode(c)}
    function joinRoomByCode(code){socket.emit('joinRoom',code,r=>{if(r.success){currentRoom=r.roomCode;showWaiting(r)}else alert(r.error||'Failed')})}

    function showWaiting(r){show('waiting');$('room-code').textContent=r.roomCode;updateSeats(r.players);$('start-btn').disabled=r.players.length<4;$('start-btn').textContent=r.players.length<4?`Á≠âÂæÖ‰∏≠ Waiting (${r.players.length}/4)`:'ÈñãÂßã Start Game!'}

    function updateSeats(players){
      const w=['east','south','west','north'],l=['Êù± East','Âçó South','Ë•ø West','Âåó North'];
      $('seats').innerHTML=w.map((wind,i)=>{
        const p=players.find(x=>x.seatWind===wind);
        const isMe=p&&p.oderId===user.id;
        return`<div class="seat${p?' filled':''}${isMe?' me':''}"><div class="wind">${l[i]}</div><div class="name${p?'':' empty'}">${p?p.displayName:'Á≠âÂæÖ‰∏≠...'}</div></div>`;
      }).join('');
      if(players.length===4){$('start-btn').disabled=false;$('start-btn').textContent='ÈñãÂßã Start Game!'}
    }

    function leaveRoom(){socket.emit('leaveRoom');currentRoom=null;showLobby()}
    function startGame(){socket.emit('startGame',r=>{if(!r.success)alert(r.error||'Failed')})}
    function startWithAI(){socket.emit('startGame',r=>{if(!r.success)alert(r.error||'Failed')})}

    function renderGame(){
      if(!gameState)return;
      $('my-hand').innerHTML=(gameState.myHand||[]).map(t=>`<div class="tile${selectedTiles.includes(t.id)?' selected':''}" onclick="clickTile(${t.id})">${t.char}</div>`).join('');
      $('my-melds').innerHTML=(gameState.myExposed||[]).map(m=>`<div class="meld">${m.tiles.map(t=>`<div class="tile">${t.char}</div>`).join('')}</div>`).join('');
      $('my-info').textContent=`${user.displayName} - ${(gameState.mySeatWind||'')[0]?.toUpperCase()||''}`;
      $('wall-count').textContent=gameState.wallCount||0;
      $('discards').innerHTML=(gameState.discardPile||[]).map(t=>`<div class="tile">${t.char}</div>`).join('');
      $('last').innerHTML=gameState.lastDiscard?`<div class="tile">${gameState.lastDiscard.char}</div>`:'';
      renderOpponents();
      $('btn-chow').disabled=!gameState.canChow;
      $('btn-pung').disabled=!gameState.canPung;
      $('btn-kong').disabled=!gameState.canKong;
      $('btn-mj').disabled=!gameState.canMahjong;
      $('turn-ind').classList.toggle('show',gameState.isMyTurn);
    }

    function renderOpponents(){
      if(!gameState.players)return;
      const myIdx=gameState.players.findIndex(p=>p.oderId===user.id);
      const pos=['opp-right','opp-top','opp-left'];
      gameState.players.forEach((p,i)=>{
        if(p.oderId===user.id)return;
        const rel=(i-myIdx+4)%4;
        if(rel<1||rel>3)return;
        const el=$(pos[rel-1]);
        if(!el)return;
        el.querySelector('.opp-name').textContent=p.displayName;
        el.querySelector('.opp-tiles').innerHTML=Array(p.handCount||0).fill('<div class="back-tile"></div>').join('');
        el.querySelector('.opp-melds').innerHTML=(p.exposed||[]).map(m=>`<div class="meld">${m.tiles.map(t=>`<div class="tile" style="width:26px;height:36px;font-size:18px">${t.char}</div>`).join('')}</div>`).join('');
      });
    }

    function clickTile(id){
      if(!gameState.isMyTurn)return;
      if(selectedTiles.includes(id)){
        socket.emit('discard',id,r=>{if(r.success)selectedTiles=[]});
        selectedTiles=[];
      }else{
        selectedTiles=[id];
      }
      renderGame();
    }

    function claimPung(){socket.emit('claimPung',r=>{if(!r.success)alert(r.error||'Cannot')})}
    function claimKong(){socket.emit('claimKong',r=>{if(!r.success)alert(r.error||'Cannot')})}
    function claimChow(){if(selectedTiles.length===2)socket.emit('claimChow',selectedTiles,r=>{if(r.success)selectedTiles=[];else alert(r.error)});else alert('Select 2 tiles ÈÅ∏Êìá2ÂºµÁâå')}
    function claimMahjong(){socket.emit('mahjong',!!gameState.lastDiscard,r=>{if(!r.success)alert(r.error||'Not winning Êú™ËÉ°Áâå')})}
    function skip(){selectedTiles=[];renderGame()}

    function handleWin(d){
      $('winner-name').textContent=d.winnerName;
      $('win-score').textContent=d.score;
      $('win-hand').innerHTML=[...(d.hand||[]),...(d.exposed||[]).flatMap(m=>m.tiles)].map(t=>`<div class="tile">${t.char}</div>`).join('');
      $('win-modal').classList.add('active');
    }

    function backToLobby(){$('win-modal').classList.remove('active');socket.emit('leaveRoom');currentRoom=null;gameState=null;$('chat-messages').innerHTML='';$('chat-panel').classList.remove('open');showLobby()}

    function toggleChat(){$('chat-panel').classList.toggle('open')}
    
    let musicPlaying=false;
    function toggleMusic(){
      const audio=$('bg-music');
      const btn=$('music-btn');
      if(musicPlaying){
        audio.pause();
        btn.textContent='üîá';
        musicPlaying=false;
      }else{
        audio.volume=0.3;
        audio.play().catch(()=>{});
        btn.textContent='üîä';
        musicPlaying=true;
      }
    }
    
    function sendChat(){
      const input=$('chat-text');
      const msg=input.value.trim();
      if(msg&&socket){
        socket.emit('chat',msg);
        input.value='';
      }
    }
    
    function addChatMessage(d){
      const msgs=$('chat-messages');
      const time=new Date(d.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
      msgs.innerHTML+=`<div class="chat-msg"><div class="name">${d.displayName}</div><div class="text">${d.message}</div><div class="time">${time}</div></div>`;
      msgs.scrollTop=msgs.scrollHeight;
    }
    
    function leaveGame(){
      if(confirm('Á¢∫ÂÆöÈõ¢ÈñãÈÅäÊà≤? Leave game?')){
        backToLobby();
      }
    }

    window.onload=()=>setTimeout(()=>{checkAuth().then(()=>$('loading').classList.remove('active'))},500);
  </script>
</body>
</html>
